<!DOCTYPE html>
<html>
<head>
  <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet">
  <link href="https://unpkg.com/vuetify/dist/vuetify.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <style>
    #app {
      background: linear-gradient(270deg, #ff00f5, #ff00a7);
      background-size: 400% 400%;

      -webkit-animation: AnimationName 30s ease infinite;
      -moz-animation: AnimationName 30s ease infinite;
      animation: AnimationName 30s ease infinite;
    }

    @-webkit-keyframes AnimationName {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    @-moz-keyframes AnimationName {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    @keyframes AnimationName {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    textarea::placeholder {
      color: #fff;
    }

    .custom-loader {
      animation: loader 1s infinite;
      display: flex;
    }
    @-moz-keyframes loader {
      from {
        transform: rotate(0);
      }
      to {
        transform: rotate(360deg);
      }
    }
    @-webkit-keyframes loader {
      from {
        transform: rotate(0);
      }
      to {
        transform: rotate(360deg);
      }
    }
    @-o-keyframes loader {
      from {
        transform: rotate(0);
      }
      to {
        transform: rotate(360deg);
      }
    }
    @keyframes loader {
      from {
        transform: rotate(0);
      }
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div id="app" >
    <v-app>
      <v-container fill-height>
        <v-layout row wrap align-center><!--xs12 sm6 offset-sm3-->
          <v-fade-transition>
            <v-flex v-show="front_page_shown" xs12 class="text-xs-center" style="height: 70%">
              <p class="text-md-center white--text display-1"><small>(　 ゜Д゜)⊃旦</small>  <b>feedmewords.fun</b>  <small>~~旦_(^O^ )</small></p>
              <p class="text-md-center white--text headline">teach ai to write stuff</p>
              <v-card style="position: relative; height: 80%; border-radius: 5px; background-color:rgba(255, 255, 255, 0.3);">
                <textarea v-model="text"
                  style="border: none; overflow: auto; outline: none; -webkit-box-shadow: none; -moz-box-shadow: none; box-shadow: none;
                    color: #ffffff; resize: none; padding: 25px; width:100%; height:100%; box-sizing: border-box; -moz-box-sizing: border-box;
                    -webkit-box-sizing: border-box;"
                  placeholder="paste some stuff here for the me to learn ~"
                ></textarea>
                <div style="position: absolute; bottom: 0; padding-left: 25px; padding-right: 25px;">
                  <span style="color: #ffffff">...or test with stuff I've already learnt</span>
                  <v-btn @click="clicked_pretrained('sienfeld')" dark flat style="text-transform: lowercase; background-color:rgba(255, 255, 255, 0.2); border-radius: 5px;">seinfeld scripts</v-btn>
                  <v-btn @click="clicked_pretrained('sienfeld')" dark flat style="text-transform: lowercase; background-color:rgba(255, 255, 255, 0.2); border-radius: 5px;">lil pump lyrics</v-btn>
                  <v-btn @click="clicked_pretrained('sienfeld')" dark flat style="text-transform: lowercase; background-color:rgba(255, 255, 255, 0.2); border-radius: 5px;">star wars prequels</v-btn>
                </div>
              </v-card>
            </v-flex>
          </v-fade-transition>
          <v-slide-x-reverse-transition>
            <v-flex v-show="main_page_shown" xs12 sm6 pr-1 class="text-xs-center" style="height: 100%">
              <v-card style="position: relative; height: 100%; border-radius: 5px; background-color:rgba(255, 255, 255, 0.3);">
                <textarea v-model="text"
                  style="border: none; overflow: auto; outline: none; -webkit-box-shadow: none; -moz-box-shadow: none; box-shadow: none;
                    color: #ffffff; resize: none; padding: 25px; width:100%; height:100%; box-sizing: border-box; -moz-box-sizing: border-box;
                    -webkit-box-sizing: border-box;"
                  placeholder="paste some stuff here for the me to learn ~"
                ></textarea>
              </v-card>
            </v-flex>
          </v-slide-x-reverse-transition>
          <v-slide-x-transition>
            <v-flex v-show="main_page_shown" xs12 sm6 pl-1 class="text-xs-center" style="height: 100%">
              <v-card style="position: relative; height: 100%; border-radius: 5px;">
                <v-btn
                  depressed
                  block
                  :loading="loading_train"
                  :disabled="loading_train"
                  color="light-blue"
                  class="mt-0 mb-0 white--text"
                  style="border-radius: 5px 5px 0px 0px; text-transform: lowercase;"
                  @click.native="loader = 'loading_train'"
                >
                  ok, let's start learning
                  <span slot="loader" class="custom-loader">
                    <v-icon light>cached</v-icon>
                  </span>
                </v-btn>
                <!--<v-btn
                  flat
                  depressed
                  block
                  :loading="loading_save"
                  :disabled="loading_save"
                  color="light-blue"
                  class="mt-0 mb-0 white--text"
                  style="border-radius: 0px; text-transform: lowercase;"
                  @click.native="loader = 'loading_save'"
                >
                  save model
                  <span slot="loader" class="custom-loader">
                    <v-icon light>save</v-icon>
                  </span>
                </v-btn>
                <v-btn
                  flat
                  depressed
                  block
                  :loading="loading_load"
                  :disabled="loading_load"
                  color="light-blue"
                  class="mt-0 mb-0 white--text"
                  style="border-radius: 0px; text-transform: lowercase;"
                  @click.native="loader = 'loading_load'"
                >
                  load existing model
                  <span slot="loader" class="custom-loader">
                    <v-icon light>save_alt</v-icon>
                  </span>
                </v-btn>-->
              </v-card>
            </v-flex>
          </v-slide-x-transition>
        </v-layout>
      </v-container>
    </v-app>
  </div>

  <script src="https://unpkg.com/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/vuetify/dist/vuetify.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.12.5"> </script>
  <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>
  <script>
    new Vue({
      el: '#app',
      data: {
        front_page_shown: true,
        main_page_shown: false,
        loader: null,
        loading_save: false,
        loading_load: false,
        loading_train: false,
        text: "JERRY: pointing at georges shirt see to me that button is in the worst possible spot the second button literally makes or breaks the shirt look at it its too high its in nomansland you look like you live with your mother <newline> GEORGE: are you through  <newline> JERRY: you do of course try on when you buy <newline> GEORGE: yes it was purple i liked it i dont actually recall considering the buttons <newline> JERRY: oh you dont recall <newline> GEORGE: on an imaginary microphone uh no not at this time <newline> JERRY: well senator id just like to know what you knew and when you knew it <newline> CLAIRE: mr seinfeld mr costanza  <newline> GEORGE: are are you sure this is decaf wheres the orange indicator <newline> CLAIRE: its missing i have to do it in my head decaf left regular right decaf left regular rightits very challenging work <newline> JERRY: can you relax its a cup of coffee claire is a professional waitress <newline> CLAIRE: trust me george no one has any interest in seeing you on caffeine <newline> GEORGE: how come youre not doin the second show tomorrow <newline> JERRY: well theres this uh woman might be comin in <newline> GEORGE: wait a second wait a second what coming in what woman is coming in <newline> JERRY: i told you about laura the girl i met in michigan <newline> GEORGE: no you didnt <newline> JERRY: i thought i told you about it yes she teaches political science i met her the night i did the show in lansing  <newline> GEORGE: ha <newline> JERRY: looks in the creamer theres no milk in here what <newline> GEORGE: wait wait wait what is she takes the milk can from jerry and puts it on the table what is she like <newline> JERRY: oh shes really great i mean shes got like a real warmth about her and shes really bright and really pretty and uh the conversation though i mean it was talking with her is like talking with you but you know obviously much better <newline> GEORGE: smiling so you know what what happened <newline> JERRY: oh nothing happened you know but is was great <newline> GEORGE: oh nothing happened but it was <newline> JERRY: yeah <newline> GEORGE: this is great <newline> JERRY: yeah <newline> GEORGE: so you know she calls and says she wants to go out with you tomorrow night god bless devil you <newline> JERRY: yeah wellnot exactly i mean she said you know she called this morning and said she had to come in for a seminar and maybe well get together  <newline> GEORGE: whistles disapprovingly ho ho ho had to had to come in <newline> JERRY: yeah but <newline> GEORGE: had to come in and maybe well get together had to and maybe <newline> JERRY: yeah <newline> GEORGE: nonono i hate to tell you this youre not gonna see this woman <newline> JERRY: what are you seriouswhy why did she call <newline> GEORGE: how do i know maybe you know maybe she wanted to be polite  <newline> JERRY: to be polite you are insane <newline> GEORGE: all right all right i didnt want to tell you this you wanna know why she called you <newline> JERRY: yes <newline> GEORGE: youre a backup youre a secondline a justincase a bplan a contingency <newline> JERRY: oh i get it this is about the button <newline> GEORGE: claire claire youre a woman right <newline> CLAIRE: what gave it away george <newline> GEORGE: uhmid like to ask youask you to analyze a hypothetical phone call you know from a female point of view <newline> GEORGE: to claire now a woman calls me all right  <newline> CLAIE: uh huh <newline> GEORGE: she says she has to come to new york on business <newline> JERRY: oh you are beautiful <newline> GEORGE: and and maybe shell see me when she gets there does this woman intend to spend time with me <newline> CLAIRE: id have to say uuhh no  <newline> CLAIRE: to be polite <newline> GEORGE: to be polite i rest my case <newline> JERRY: good did you have fun you have no idea what youre talking about now come on come with me stands up i gotta go get my stuff out of the dryer anyway <newline> GEORGE: im not gonna watch you do laundry <newline> JERRY: oh come on be a comewith guy <newline> GEORGE: come on im tired <newline> CLAIRE: to jerry dont worry i gave him a little caffeine hell perk up <newline> GEORGE: panicking right i knew i felt something <newline> GEORGE: jerry i have to tell you something this is the dullest moment ive ever experienced  <newline> JERRY: well look at this guy look hes got everything hes got detergents sprays fabric softeners this is not his first load <newline> GEORGE: i need a break jerry you know i gotta get out of the city i feel so cramped <newline> JERRY: and you didnt even hear how she sounded <newline> GEORGE: what <newline> JERRY: laura <newline> GEORGE: i cant believe falls on his knees we already discussed this <newline> JERRY: yeah but how could you be so sure <newline> GEORGE: cause its signals jerry its signals snapping his fingers dont you all right did she even ask you what you were doin tomorrow night if you were busy <newline> JERRY: no <newline> GEORGE: she calls you today and she doesnt make a plan for tomorrow what is that its saturday night <newline> JERRY: yeah <newline> GEORGE: what is that its ridiculous you dont even know what hotel shes staying at you cant call her thats a signal jerry thats a signal snaps his fingers signal <newline> JERRY: maybe youre right <newline> GEORGE: maybe im right of course im right <newline> JERRY: this is insane you know i dont even know where shes staying she shes not gonna call me this is unbelievable <newline>"
      },
      methods: {
        clicked_pretrained: async function(id) {
          console.log("clicked " + id)
          this.front_page_shown = false
          await this.delay(300);
          this.main_page_shown = true
        },
        delay: function(ms) {
          return new Promise(resolve => {
            setTimeout(resolve, ms);
          });
        },
        onlyUnique: function(value, index, self) {
          return self.indexOf(value) === index;
        },
        indexOfMax: function(arr) {
            if (arr.length === 0) {
                return -1;
            }
            var max = arr[0];
            var maxIndex = 0;
            for (var i = 1; i < arr.length; i++) {
                if (arr[i] > max) {
                    maxIndex = i;
                    max = arr[i];
                }
            }
            return maxIndex;
        },
        sample: function(preds, temperature) {
          preds = nj.array(preds, 'float64');
          preds = nj.log(preds).divide(temperature)
          exp_preds = nj.exp(preds)
          preds = exp_preds.divide(nj.sum(exp_preds))
          arr = preds.tolist()
          return this.indexOfMax(arr)
        },
        ok: async function() {

          console.log('corpus length:', this.text.length)
          words = this.text.split(" ")
          console.log("init " + words)
          words = words.filter(this.onlyUnique)
          console.log("unique" + words)
          words = words.sort()
          console.log("sorted" + words)

          console.log("total number of unique words" + words.length)

          /*word_indices_arr = Array.from(words.entries())
          indices_word_arr = []
          for(let arr of word_indices_arr) {
            indices_word_arr.push(arr.reverse())
          }*/
          word_indices = {}
          indices_word = {}
          for (let e0 of words.entries()) {
            idx = e0[0]
            word = e0[1]
            word_indices[word] = idx
            indices_word[idx] = word
          }
          console.log("WORD_INDICES" + JSON.stringify(word_indices))
          console.log("INDICES_WORD" + JSON.stringify(indices_word))

          console.log("word_indices length:" + word_indices.length)
          console.log("indices_words length" + indices_word.length)

          const maxlen = 30;
          const step = 3;
          const iterations_length = 2;
          console.log("maxlen: " + maxlen, "step: " + step)

          sentences = []
          sentences1 = []

          next_words = []
          list_words = this.text.toLowerCase().split(" ")

          for (var i = 0; i < (list_words.length - maxlen); i += step) {
            sentences2 = list_words.slice(i, i + maxlen + 1).join(" ") //TODO added + 1, mutually inclusive?
            sentences.push(sentences2)
            next_words.push(list_words[i + maxlen])
          }
          console.log('nb sequences(length of sentences):', sentences.length)
          console.log("length of next_word", next_words.length)

          console.log('Vectorization...')
          X = nj.zeros([sentences.length, maxlen, words.length])
          console.log('X shape' + X.shape)
          y = nj.zeros([sentences.length, words.length])
          console.log('y shape' + y.shape)
          for (e of sentences.entries()) {
            i = e[0]
            sentence = e[1]
            for (e2 of sentence.split(" ").entries()) {
              t = e2[0]
              word = e2[1]
              X.set(i, t, word_indices[word], 1)
            }
            y.set(i, word_indices[next_words[i]], 1)
          }
          console.log(JSON.stringify(X))
          console.log(JSON.stringify(y))

          console.log('Creating model... Please wait.');

          model = tf.sequential();
          model.add(tf.layers.lstm({
            units: 128,
            returnSequences: true,
            inputShape: [maxlen, words.length]
          }));
          model.add(tf.layers.dropout(0.2))
          model.add(tf.layers.lstm({
            units: 128,
            returnSequences: false
          }));
          model.add(tf.layers.dropout(0.2))
          model.add(tf.layers.dense({units: words.length, activation: 'softmax'}));

          model.compile({loss: 'categoricalCrossentropy', optimizer: 'sgd'});

          for (var iteration = 1; iteration < iterations_length; iteration++) {
            console.log('Iteration', iteration)
            await model.fit(tf.tensor3d(X.tolist()), tf.tensor2d(y.tolist()), {
              epochs: 2,
              batchSize: 128,
              callbacks: {
                onTrainBegin: async () => {
                  console.log("onTrainBegin")
                },
                onTrainEnd: async (epoch, logs) => {
                  console.log("onTrainEnd" + epoch + JSON.stringify(logs))
                },
                onEpochBegin: async (epoch, logs) => {
                  console.log("onEpochBegin" + epoch + JSON.stringify(logs))
                },
                onEpochEnd: async (epoch, logs) => {
                  console.log("onEpochEnd" + epoch + JSON.stringify(logs))
                },
                onBatchBegin: async (epoch, logs) => {
                  console.log("onBatchBegin" + epoch + JSON.stringify(logs))
                },
                onBatchEnd: async (epoch, logs) => {
                  console.log("onBatchEnd" + epoch + JSON.stringify(logs))
                }
              }
            })/*.then(results => {
              console.log('ok')
              console.log(results)
            })*/
            //await model.fit(tf.tensor3d(X.tolist()), tf.tensor2d(y.tolist()), {epochs: 2, batchSize: 128})
            console.log("done fitting")
            start_index = Math.floor(Math.random() * (list_words.length - maxlen - 1))
            arr = [0.2, 0.5, 1.0, 1.2]
            for (let diversity of arr) {
              console.log('----- diversity:', diversity)
              generated = ''
              sentence = list_words.slice(start_index, start_index + maxlen + 1)
              generated += sentence.join(" ")
              console.log(generated)
              var str = ""
              for (var i = 0; i < 10; i++) {
                var x_pred = nj.zeros([1, maxlen, words.length])
                for (e3 of sentence.entries()) {
                  t = e3[0]
                  word = e3[1]
                  x_pred.set(0, t, word_indices[word], 1)
                }
                x_pred2 = x_pred.tolist()
                var test = tf.tensor3d(x_pred2)
                const output = model.predict(test)//await model.predict(inputData)
                var output_data = await output.dataSync()
                var preds = Array.prototype.slice.call(output_data);
                var next_index = this.sample(preds, diversity)
                console.log('next_index' + next_index + " :: " + indices_word[next_index])
                var next_word = indices_word[next_index]
                generated += next_word
                //console.log("sentence " + sentence)
                sentence.shift()
                //console.log(sentence)
                str += next_word + " "
                console.log(str)
              }
            }
          }
          console.log(
              'Done creating model. ' +
              'Now you can train the model or use it to generate text.');
          }
      },
      watch: {
        loader () {
          const l = this.loader
          this[l] = !this[l]

          setTimeout(() => (this[l] = false), 3000)

          this.loader = null
        },
        text: async function() {
          this.front_page_shown = false
          await this.delay(300);
          this.main_page_shown = true
        }
      },
      mounted: function() {
        //this.ok()
      }
    })
  </script>
</body>
</html>
